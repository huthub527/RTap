<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>R Tycoon Tapper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        text-align: center;
        background: linear-gradient(to bottom, #3a4bd1, #672ea8);
        color: white;
        overflow-x: hidden;
    }

    h1, h2, h3 { margin: 10px 0; }

    /* HUD */
    #hud {
        padding-top: 35px;
        padding-bottom: 10px;
        position: relative;
        z-index: 10;
    }
    .hudLine { margin: 4px 0; }

    /* COIN */
    #coin {
        width: 220px;
        height: 220px;
        margin: 25px auto;
        border-radius: 50%;
        background: radial-gradient(circle, #ffd861, #d49a00);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 90px;
        font-weight: bold;
        color: #5a3d00;
        box-shadow: 0 0 40px rgba(255,255,0,0.55);
        user-select: none;
        touch-action: manipulation;
        position: relative;
        z-index: 5;
    }

    /* PANELS */
    .panel {
        margin: 15px auto;
        width: 90%;
        padding: 20px;
        background: rgba(0,0,0,0.25);
        border-radius: 18px;
    }

    button {
        width: 85%;
        max-width: 350px;
        padding: 14px;
        margin: 10px auto;
        background: rgba(255,255,255,0.1);
        border: 2px solid white;
        border-radius: 14px;
        font-size: 18px;
        color: white;
        display: block;
    }

    input {
        width: 85%;
        max-width: 350px;
        padding: 12px;
        margin: 10px auto;
        border-radius: 10px;
        border: none;
        font-size: 18px;
        text-align: center;
        display: block;
    }

    /* MODAL */
    #modalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.75);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        backdrop-filter: blur(4px);
        overflow: hidden;
    }

    #modalBox {
        width: 88%;
        max-width: 380px;
        background: #1a1a1a;
        padding: 25px;
        border-radius: 16px;
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: 100000;
    }
</style>
</head>

<body>

<!-- HUD -->
<div id="hud">
    <div id="balanceText" class="hudLine">Balance: 0 R</div>
    <div id="tapMessage" class="hudLine">Tap the coin to begin!</div>
    <div id="comboText" class="hudLine">Last session taps: 0</div>
    <div id="userText" class="hudLine">(tap to switch user)</div>
</div>

<!-- COIN -->
<div id="coin">R</div>

<!-- PANELS -->
<div class="panel">
    <h2>Upgrades</h2>
    <button onclick="upgradeTap()">Tap Power +1 (Cost: 20 R)</button>
    <button onclick="upgradeOffline()">Offline Boost (Cost: 75 R)</button>
</div>

<div class="panel">
    <h2>Vault</h2>
    <h3 id="vaultText">Vault: 0 R</h3>
    <button onclick="deposit10()">Deposit 10 R</button>
    <button onclick="depositAll()">Deposit ALL R</button>
    <button onclick="withdraw10()">Withdraw 10 R → Tokens</button>
    <button onclick="withdrawAll()">Withdraw ALL R → Tokens</button>
</div>

<div class="panel">
    <h2>Token Wallet</h2>
    <h3 id="tokenText">Tokens: 0 T</h3>
</div>

<div class="panel">
    <h2>Send R to Another User</h2>
    <input id="sendUser" placeholder="Recipient Username">
    <input id="sendAmount" type="number" placeholder="Amount of R">

    <button onclick="sendFromBalance()">Send From Balance</button>
    <button onclick="sendFromVault()">Send From Vault</button>
</div>

<!-- MODAL -->
<div id="modalOverlay">
    <div id="modalBox">
        <h2>User Login</h2>
        <input id="usernameInput" placeholder="Username">
        <input id="pinInput" placeholder="PIN" type="password">

        <button onclick="loginUser()">Login</button>
        <button onclick="createUser()">Create New User</button>
        <button style="background:#a00000" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
/* ---------- DOM SHORTCUTS ---------- */
const balanceText   = document.getElementById("balanceText");
const tapMessage    = document.getElementById("tapMessage");
const comboText     = document.getElementById("comboText");
const userText      = document.getElementById("userText");
const vaultText     = document.getElementById("vaultText");
const tokenText     = document.getElementById("tokenText");
const sendUserInput = document.getElementById("sendUser");
const sendAmountInput = document.getElementById("sendAmount");
const coin          = document.getElementById("coin");
const modalOverlay  = document.getElementById("modalOverlay");
const usernameInput = document.getElementById("usernameInput");
const pinInput      = document.getElementById("pinInput");

/* ---------- USER STORAGE ---------- */
let users = JSON.parse(localStorage.getItem("rtycoon_users") || "{}");

for (let u in users) {
    users[u].balance      = Number(users[u].balance)      || 0;
    users[u].vault        = Number(users[u].vault)        || 0;
    users[u].tokens       = Number(users[u].tokens)       || 0;
    users[u].tapPower     = Number(users[u].tapPower)     || 1;
    users[u].cooldownEnd  = Number(users[u].cooldownEnd)  || 0;
    users[u].receivedLog  = users[u].receivedLog || [];  // array of messages
}

let currentUser = null;

/* Tap session state */
let tapSessionActive = false;
let tapCount = 0;
let tapSessionEndTime = 0;
let lastSessionTaps = 0;

const tapWindowMs = 10000;          // 10 seconds
const cooldownMs = 30 * 60 * 1000;  // 30 minutes

function saveUsers() {
    localStorage.setItem("rtycoon_users", JSON.stringify(users));
}

/* ---------- MODAL CONTROL ---------- */
function openLogin() {
    modalOverlay.style.display = "flex";
}

function closeModal() {
    modalOverlay.style.display = "none";
}

/* ---------- USER CREATION ---------- */
function createUser() {
    const u = usernameInput.value.trim();
    const p = pinInput.value.trim();
    if (!u || !p) {
        alert("Enter username and PIN.");
        return;
    }
    if (users[u]) {
        alert("That user already exists.");
        return;
    }

    users[u] = {
        pin: p,
        balance: 0,
        vault: 0,
        tokens: 0,
        tapPower: 1,
        cooldownEnd: 0,
        receivedLog: []
    };

    saveUsers();
    alert("User created! Now log in with that user.");
}

/* ---------- LOGIN ---------- */
function loginUser() {
    const u = usernameInput.value.trim();
    const p = pinInput.value.trim();
    if (!users[u]) {
        alert("User not found.");
        return;
    }
    if (users[u].pin !== p) {
        alert("Wrong PIN.");
        return;
    }

    currentUser = u;
    tapSessionActive = false;
    tapCount = 0;
    closeModal();
    updateHUD();

    // Show any received notifications
    const U = users[currentUser];
    if (U.receivedLog && U.receivedLog.length > 0) {
        alert(U.receivedLog.join("\n"));
        U.receivedLog = [];
        saveUsers();
    }
}

/* ---------- SCROLL PRESERVATION ---------- */
function preserveScroll(fn) {
    const y = window.scrollY;
    fn();
    window.scrollTo(0, y);
}

/* ---------- TAP → R CONVERSION ---------- */
function tapsToR(taps) {
    // Non-1:1 conversion so 98 taps ≈ 4–6 R.
    function randInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    if (taps < 20)        return randInt(0, 1);
    else if (taps < 40)   return randInt(1, 3);
    else if (taps < 70)   return randInt(3, 5);
    else if (taps < 100)  return randInt(4, 6);   // 98 taps falls here
    else if (taps < 150)  return randInt(5, 8);
    else                  return randInt(8, 10);
}

/* ---------- COIN TAP LOGIC ---------- */
coin.addEventListener("click", () => {
    if (!currentUser) {
        openLogin();
        return;
    }

    const U = users[currentUser];
    const now = Date.now();

    // Check cooldown
    if (now < U.cooldownEnd) {
        const remainingMin = Math.ceil((U.cooldownEnd - now) / 60000);
        tapMessage.textContent = `Cooldown: ${remainingMin} min left`;
        return;
    }

    // Start new session if not active
    if (!tapSessionActive) {
        tapSessionActive = true;
        tapCount = 0;
        tapSessionEndTime = now + tapWindowMs;
        tapMessage.textContent = "TAP TAP TAP!";
    }

    // If time is up, finish the session
    if (now >= tapSessionEndTime) {
        finishTapSession();
        return;
    }

    // Count the tap
    tapCount++;
    comboText.textContent = `Session taps: ${tapCount}`;
});

function finishTapSession() {
    if (!currentUser) return;

    tapSessionActive = false;
    lastSessionTaps = tapCount;

    const U = users[currentUser];
    const earnedR = tapsToR(tapCount) * U.tapPower;

    U.balance += earnedR;
    U.cooldownEnd = Date.now() + cooldownMs;

    saveUsers();
    updateHUD();

    tapMessage.textContent = `You earned ${earnedR} R from ${tapCount} taps. Cooldown started.`;
    comboText.textContent = `Last session taps: ${lastSessionTaps}`;
}

/* ---------- UPGRADE SYSTEM ---------- */
function upgradeTap() {
    if (!currentUser) return openLogin();
    preserveScroll(() => {
        const U = users[currentUser];
        const cost = 20;
        if (U.balance >= cost) {
            U.balance -= cost;
            U.tapPower += 1;
            saveUsers();
            updateHUD();
        } else {
            alert("Not enough R to upgrade Tap Power.");
        }
    });
}

function upgradeOffline() {
    if (!currentUser) return openLogin();
    preserveScroll(() => {
        const U = users[currentUser];
        const cost = 75;
        if (U.balance >= cost) {
            U.balance -= cost;
            U.offlineBoost = (U.offlineBoost || 0) + 1;
            saveUsers();
            updateHUD();
            alert("Offline Boost purchased! (placeholder effect)");
        } else {
            alert("Not enough R for Offline Boost.");
        }
    });
}

/* ---------- VAULT CONTROLS ---------- */
function deposit10() {
    if (!currentUser) return openLogin();
    preserveScroll(() => {
        const U = users[currentUser];
        if (U.balance >= 10) {
            U.balance -= 10;
            U.vault += 10;
            saveUsers();
            updateHUD();
        }
    });
}

function depositAll() {
    if (!currentUser) return openLogin();
    preserveScroll(() => {
        const U = users[currentUser];
        U.vault += U.balance;
        U.balance = 0;
        saveUsers();
        updateHUD();
    });
}

function withdraw10() {
    if (!currentUser) return openLogin();
    preserveScroll(() => {
        const U = users[currentUser];
        if (U.vault >= 10) {
            U.vault -= 10;
            U.tokens += 10;
            saveUsers();
            updateHUD();
        }
    });
}

function withdrawAll() {
    if (!currentUser) return openLogin();
    preserveScroll(() => {
        const U = users[currentUser];
        U.tokens += U.vault;
        U.vault = 0;
        saveUsers();
        updateHUD();
    });
}

/* ---------- P2P TRANSFER SYSTEM ---------- */
function sendFromBalance() {
    if (!currentUser) return openLogin();
    preserveScroll(() => {
        const senderName = currentUser;
        const receiverName = sendUserInput.value.trim();
        const amount = Number(sendAmountInput.value.trim());

        if (!receiverName || !users[receiverName]) {
            alert("Recipient user not found.");
            return;
        }
        if (receiverName === senderName) {
            alert("You cannot send R to yourself.");
            return;
        }
        if (!amount || amount <= 0) {
            alert("Enter a valid amount.");
            return;
        }

        const sender = users[senderName];
        const receiver = users[receiverName];

        if (sender.balance < amount) {
            alert("Not enough R in balance.");
            return;
        }

        sender.balance -= amount;
        receiver.balance += amount;

        // Add notification to receiver
        receiver.receivedLog = receiver.receivedLog || [];
        receiver.receivedLog.push(`You received ${amount} R from ${senderName}.`);

        saveUsers();
        updateHUD();
        alert(`Sent ${amount} R from BALANCE to ${receiverName}.`);
    });
}

function sendFromVault() {
    if (!currentUser) return openLogin();
    preserveScroll(() => {
        const senderName = currentUser;
        const receiverName = sendUserInput.value.trim();
        const amount = Number(sendAmountInput.value.trim());

        if (!receiverName || !users[receiverName]) {
            alert("Recipient user not found.");
            return;
        }
        if (receiverName === senderName) {
            alert("You cannot send R to yourself.");
            return;
        }
        if (!amount || amount <= 0) {
            alert("Enter a valid amount.");
            return;
        }

        const sender = users[senderName];
        const receiver = users[receiverName];

        if (sender.vault < amount) {
            alert("Not enough R in vault.");
            return;
        }

        sender.vault -= amount;
        receiver.balance += amount;

        // Add notification to receiver
        receiver.receivedLog = receiver.receivedLog || [];
        receiver.receivedLog.push(`You received ${amount} R from ${senderName} (from their Vault).`);

        saveUsers();
        updateHUD();
        alert(`Sent ${amount} R from VAULT to ${receiverName}.`);
    });
}

/* ---------- HUD UPDATE ---------- */
function updateHUD() {
    if (!currentUser) return;

    const U = users[currentUser];
    const now = Date.now();

    balanceText.textContent = `Balance (${currentUser}): ${U.balance} R`;
    vaultText.textContent   = `Vault: ${U.vault} R`;
    tokenText.textContent   = `Tokens: ${U.tokens} T`;
    comboText.textContent   = `Last session taps: ${lastSessionTaps}`;

    if (now < U.cooldownEnd) {
        const remainingMin = Math.ceil((U.cooldownEnd - now) / 60000);
        tapMessage.textContent = `Cooldown: ${remainingMin} min left`;
    } else if (tapSessionActive) {
        tapMessage.textContent = "Tapping session in progress!";
    } else {
        tapMessage.textContent = "Tap the coin to begin!";
    }

    userText.textContent = `User: ${currentUser} (tap to switch)`;
}

/* Switch user on HUD tap */
userText.addEventListener("click", () => {
    openLogin();
});

/* Auto-open login on load */
window.onload = () => {
    openLogin();
};
</script>

</body>
</html>