<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>R Tycoon Tapper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        text-align: center;
        background: linear-gradient(to bottom, #3a4bd1, #672ea8);
        color: white;
        overflow-x: hidden;
    }

    h1, h2, h3 { margin: 10px 0; }

    #hud {
        padding-top: 35px;
        padding-bottom: 10px;
        position: relative;
        z-index: 10;
    }

    .hudLine { margin: 4px 0; font-size: 18px; }

    #coin {
        width: 220px;
        height: 220px;
        margin: 25px auto;
        border-radius: 50%;
        background: radial-gradient(circle, #ffd861, #d49a00);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 90px;
        font-weight: bold;
        color: #5a3d00;
        box-shadow: 0 0 40px rgba(255,255,0,0.55);
        user-select: none;
        touch-action: manipulation;
        position: relative;
        z-index: 5;
    }

    .panel {
        margin: 15px auto;
        width: 90%;
        max-width: 600px;
        padding: 20px;
        background: rgba(0,0,0,0.25);
        border-radius: 18px;
    }

    button {
        width: 85%;
        max-width: 350px;
        padding: 14px;
        margin: 10px auto;
        background: rgba(255,255,255,0.1);
        border: 2px solid white;
        border-radius: 14px;
        font-size: 18px;
        color: white;
        display: block;
    }

    input {
        width: 85%;
        max-width: 350px;
        padding: 10px;
        margin: 6px auto;
        border-radius: 10px;
        border: none;
        font-size: 16px;
        text-align: center;
        display: block;
    }

    textarea {
        width: 85%;
        max-width: 380px;
        height: 140px;
        padding: 10px;
        margin: 10px auto;
        border-radius: 10px;
        border: none;
        font-size: 14px;
        resize: vertical;
        box-sizing: border-box;
    }

    #modalOverlay, #importOverlay, #dailyOverlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.75);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        backdrop-filter: blur(4px);
        overflow: hidden;
    }

    #modalBox, #importBox, #dailyBox {
        width: 88%;
        max-width: 380px;
        background: #1a1a1a;
        padding: 25px;
        border-radius: 16px;
        position: fixed;
        left: 50%; top: 50%;
        transform: translate(-50%, -50%);
        z-index: 100000;
    }
</style>
</head>

<body>

<div id="hud">
    <div id="balanceText" class="hudLine">Balance: 0 R</div>
    <div id="tapMessage" class="hudLine">Tap the coin to begin!</div>
    <div id="comboText" class="hudLine">Last session taps: 0</div>
    <div id="userText" class="hudLine">(tap to switch user)</div>
</div>

<div id="coin">R</div>

<div class="panel">
    <h2>Vault</h2>
    <h3 id="vaultText">Vault: 0 R</h3>
    <button onclick="deposit10()">Deposit 10 R</button>
    <button onclick="depositAll()">Deposit ALL R</button>
    <button onclick="withdraw10()">Withdraw 10 R → Tokens</button>
    <button onclick="withdrawAll()">Withdraw ALL R → Tokens</button>
</div>

<div class="panel">
    <h2>Token Wallet</h2>
    <h3 id="tokenText">Tokens: 0 T</h3>
</div>

<div class="panel">
    <h2>Shared Wallet</h2>
    <h3 id="sharedText">Shared Wallet: 0 R</h3>

    <button onclick="depositShared10()">Deposit 10 R from Vault → Shared</button>
    <button onclick="withdrawShared10()">Withdraw 10 R from Shared → Vault</button>

    <input id="sendUserInput" placeholder="Send to user">
    <input id="sendAmountInput" placeholder="Amount" type="number" min="1">
    <button onclick="sendFromShared()">Send from Shared → User</button>
</div>

<div class="panel">
    <h2>Data Management</h2>
    <button onclick="exportSave()">Export Save (local backup)</button>
    <button onclick="openImportModal()">Import Save (local backup)</button>
</div>

<!-- Login Modal -->
<div id="modalOverlay">
    <div id="modalBox">
        <h2>User Login</h2>
        <input id="usernameInput" placeholder="Username">
        <input id="pinInput" placeholder="PIN" type="password">

        <button onclick="loginUser()">Login</button>
        <button onclick="createUser()">Create User</button>
        <button style="background:#a00000" onclick="closeModal()">Cancel</button>
    </div>
</div>

<!-- Import Modal -->
<div id="importOverlay">
    <div id="importBox">
        <h2>Import Save</h2>
        <textarea id="importText" placeholder='{"User":{...}}'></textarea>
        <button onclick="importSave()">Import</button>
        <button style="background:#a00000" onclick="closeImportModal()">Cancel</button>
    </div>
</div>

<!-- Daily Math Challenge -->
<div id="dailyOverlay">
    <div id="dailyBox">
        <h2>Daily Math Challenge</h2>
        <p id="dailyQuestion">Loading…</p>
        <input id="dailyAnswer" type="number" placeholder="Your answer">
        <button onclick="submitDaily()">Submit</button>
        <button style="background:#a00000" onclick="closeDailyModal()">Close</button>
    </div>
</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ============================================================
   CONFIG — Supabase
   ============================================================ */

const SUPABASE_URL = "https://ucbdicziipbdgwibmhjf.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjYmRpY3ppaXBiZGd3aWJtaGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDIwMjEsImV4cCI6MjA3ODY3ODAyMX0.BIj0rddCc9sK8jGlDaf0RPvMIZMCDVezAJdNXH9KkvY";

const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
);

/* ============================================================
   LOCAL BACKUP STRUCTURE
   ============================================================ */

let users = JSON.parse(localStorage.getItem("rtycoon_users") || "{}");

function normalizeUser(u) {
    if (!u) u = {};
    return {
        pin: u.pin || "",
        balance: Number(u.balance) || 0,
        vault: Number(u.vault) || 0,
        tokens: Number(u.tokens) || 0,
        shared: Number(u.shared) || 0,

        // tapMultiplier fixed at 1 (no pay-to-win)
        tapMultiplier: 1,

        cooldownEnd: Number(u.cooldownEnd) || 0,
        lastSessionTaps: Number(u.lastSessionTaps) || 0,
        offlineBoost: Number(u.offlineBoost) || 0,
        nextDailyTime: Number(u.nextDailyTime) || 0,
        receivedLog: Array.isArray(u.receivedLog) ? u.receivedLog : []
    };
}

// normalize everything from storage
for (const n in users) users[n] = normalizeUser(users[n]);

function saveLocalUsers() {
    localStorage.setItem("rtycoon_users", JSON.stringify(users));
}

/* ============================================================
   TAP / COOLDOWN CONSTANTS
   ============================================================ */

const TAP_WINDOW_MS = 10_000;              // 10 seconds
const COOLDOWN_MS  = 35 * 60 * 1000;       // 35 minutes

let currentUser = null;
let currentUserId = null; // Supabase row id (uuid)

let tapSessionStart = 0;
let tapCountThisSession = 0;
let tapWindowTimer = null;

let dailyCorrectAnswer = null;

/* ============================================================
   MODALS
   ============================================================ */

function openLogin(){ modalOverlay.style.display="flex"; }
function closeModal(){ modalOverlay.style.display="none"; }

function openImportModal(){ importOverlay.style.display="flex"; }
function closeImportModal(){ importOverlay.style.display="none"; }

function openDailyModal(){ dailyOverlay.style.display="flex"; }
function closeDailyModal(){ dailyOverlay.style.display="none"; }

/* ============================================================
   HELPERS: Supabase <-> Local mapping
   ============================================================ */

function rowToUser(row) {
    // converts a Supabase row into our local user object
    return normalizeUser({
        pin: row.pin,
        balance: row.balance,
        vault: row.vault,
        tokens: row.tokens,
        shared: row.shared,
        cooldownEnd: row.cooldown_end,
        lastSessionTaps: row.last_session_taps,
        nextDailyTime: row.next_daily_time,
        offlineBoost: row.offline_boost,
        receivedLog: row.received_log || []
    });
}

function userToRow(username, user) {
    return {
        username,
        pin: user.pin,
        balance: user.balance,
        vault: user.vault,
        tokens: user.tokens,
        shared: user.shared,
        cooldown_end: user.cooldownEnd,
        last_session_taps: user.lastSessionTaps,
        next_daily_time: user.nextDailyTime,
        offline_boost: user.offlineBoost,
        received_log: user.receivedLog
    };
}

/* ============================================================
   CLOUD SAVE (safe & simple)
   ============================================================ */

async function saveToSupabase(username) {
    if (!currentUserId || !username || !users[username]) return;

    const U = users[username];
    const row = userToRow(username, U);

    try {
        const { error } = await supabaseClient
            .from("Users")
            .update(row)
            .eq("id", currentUserId);

        if (error) {
            console.warn("Supabase update error:", error.message);
        }
    } catch (err) {
        console.warn("Supabase update failed (offline?):", err);
    }
}

async function refreshFromSupabase(username, pin) {
    try {
        const { data, error } = await supabaseClient
            .from("Users")
            .select("*")
            .eq("username", username)
            .eq("pin", pin)
            .maybeSingle();

        if (error) {
            console.warn("Supabase select error:", error.message);
            return null;
        }
        return data || null;
    } catch (err) {
        console.warn("Supabase select failed:", err);
        return null;
    }
}

/* ============================================================
   CREATE / LOGIN (cloud-first, local backup)
   ============================================================ */

async function createUser(){
    const u = usernameInput.value.trim();
    const p = pinInput.value.trim();

    if(!u || !p) {
        alert("Enter username + PIN");
        return;
    }

    // Check if username already exists in Supabase
    try {
        const { data: existing, error: selErr } = await supabaseClient
            .from("Users")
            .select("id")
            .eq("username", u)
            .maybeSingle();

        if (selErr) {
            console.warn("Supabase check error:", selErr.message);
        }

        if (existing) {
            alert("Username already exists in the cloud!");
            return;
        }
    } catch (err) {
        console.warn("Supabase check failed:", err);
    }

    // create local default user
    const newUser = normalizeUser({ pin: p });
    users[u] = newUser;
    saveLocalUsers();

    // insert into Supabase
    try {
        const row = userToRow(u, newUser);
        const { data, error } = await supabaseClient
            .from("Users")
            .insert(row)
            .select()
            .maybeSingle();

        if (error) {
            console.warn("Supabase insert error:", error.message);
            alert("User created locally, but cloud save failed. You can still play.");
        } else {
            currentUserId = data.id;
        }
    } catch (err) {
        console.warn("Supabase insert failed:", err);
        alert("User created locally, but cloud save failed (probably offline).");
    }

    alert("User created!");
}

async function loginUser(){
    const u = usernameInput.value.trim();
    const p = pinInput.value.trim();

    if(!u || !p) {
        alert("Enter username + PIN");
        return;
    }

    // Try Supabase first
    let row = await refreshFromSupabase(u, p);

    if (row) {
        // Cloud user found
        currentUserId = row.id;
        users[u] = rowToUser(row);
        saveLocalUsers();
        currentUser = u;
        tapSessionStart = 0;
        tapCountThisSession = 0;
        closeModal();
        updateHUD();
        return;
    }

    // fallback to local storage
    if (!users[u]) {
        alert("User not found (cloud or local).");
        return;
    }
    const localUser = users[u];
    if (localUser.pin !== p) {
        alert("Wrong PIN (using local backup).");
        return;
    }

    currentUser = u;
    currentUserId = null; // we don't know the cloud id
    tapSessionStart = 0;
    tapCountThisSession = 0;
    closeModal();
    updateHUD();
}

/* ============================================================
   GAME LOGIC – TAP & SESSION
   ============================================================ */

document.getElementById("coin").addEventListener("click", () => {
    if (!currentUser) return openLogin();

    const U = users[currentUser];
    const now = Date.now();

    // cooldown check
    if (now < U.cooldownEnd) {
        const remain = U.cooldownEnd - now;
        const m = Math.floor(remain / 60000);
        const s = Math.floor((remain % 60000) / 1000);
        tapMessage.textContent = `Cooldown: ${m}m ${s}s`;
        return;
    }

    // start new tap window
    if (!tapSessionStart) {
        tapSessionStart = now;
        tapCountThisSession = 0;
        clearTimeout(tapWindowTimer);
        tapWindowTimer = setTimeout(() => endTapSession(), TAP_WINDOW_MS);
    }

    // 1 tap = 1 R (tapMultiplier is fixed at 1)
    tapCountThisSession++;
    U.balance += 1;

    saveLocalUsers();
    updateHUD();
});

function endTapSession() {
    if (!currentUser) return;
    const U = users[currentUser];
    const now = Date.now();

    if (!tapSessionStart) return;

    U.lastSessionTaps = tapCountThisSession;
    U.cooldownEnd = now + COOLDOWN_MS;

    tapSessionStart = 0;
    tapCountThisSession = 0;

    saveLocalUsers();
    updateHUD();
    // save to cloud after each finished session
    saveToSupabase(currentUser);
}

/* ============================================================
   DAILY MATH SYSTEM
   ============================================================ */

function maybeTriggerDaily(){
    if(!currentUser) return;

    const U = users[currentUser];
    const now = Date.now();

    // respect nextDailyTime
    if (now < U.nextDailyTime) return;

    const hour = new Date().getHours();
    if (hour < 8 || hour > 22) return; // only during 8am–10pm

    // ~0.25% chance every 30s while playing
    if (Math.random() < 0.0025){
        startDailyChallenge();
    }
}

function startDailyChallenge(){
    const U = users[currentUser];

    let a = Math.floor(Math.random()*30) + 1;
    let b = Math.floor(Math.random()*30) + 1;
    dailyCorrectAnswer = a + b;

    dailyQuestion.textContent = `${a} + ${b} = ?`;
    dailyAnswer.value = "";
    openDailyModal();

    const tomorrow = new Date();
    tomorrow.setHours(24,0,0,0); // midnight
    U.nextDailyTime = tomorrow.getTime();

    saveLocalUsers();
    saveToSupabase(currentUser);
}

function submitDaily(){
    const ans = Number(dailyAnswer.value.trim());
    if(ans === dailyCorrectAnswer){
        const U = users[currentUser];
        U.balance += 300;
        saveLocalUsers();
        saveToSupabase(currentUser);
        alert("Correct! +300 R");
        closeDailyModal();
        updateHUD();
    } else {
        alert("Incorrect.");
    }
}

/* ============================================================
   VAULT + TOKENS
   ============================================================ */

function ensureLogged() {
    if (!currentUser) {
        openLogin();
        return false;
    }
    return true;
}

function deposit10(){
    if(!ensureLogged()) return;
    const U = users[currentUser];
    if(U.balance >= 10){
        U.balance -= 10;
        U.vault += 10;
        saveLocalUsers();
        saveToSupabase(currentUser);
        updateHUD();
    }
}

function depositAll(){
    if(!ensureLogged()) return;
    const U = users[currentUser];
    U.vault += U.balance;
    U.balance = 0;
    saveLocalUsers();
    saveToSupabase(currentUser);
    updateHUD();
}

function withdraw10(){
    if(!ensureLogged()) return;
    const U = users[currentUser];
    if(U.vault >= 10){
        U.vault -= 10;
        U.tokens += 10;
        saveLocalUsers();
        saveToSupabase(currentUser);
        updateHUD();
    }
}

function withdrawAll(){
    if(!ensureLogged()) return;
    const U = users[currentUser];
    U.tokens += U.vault;
    U.vault = 0;
    saveLocalUsers();
    saveToSupabase(currentUser);
    updateHUD();
}

/* ============================================================
   SHARED WALLET + SEND
   ============================================================ */

function depositShared10(){
    if(!ensureLogged()) return;
    const U = users[currentUser];
    if(U.vault >= 10){
        U.vault -= 10;
        U.shared += 10;
        saveLocalUsers();
        saveToSupabase(currentUser);
        updateHUD();
    }
}

function withdrawShared10(){
    if(!ensureLogged()) return;
    const U = users[currentUser];
    if(U.shared >= 10){
        U.shared -= 10;
        U.vault += 10;
        saveLocalUsers();
        saveToSupabase(currentUser);
        updateHUD();
    }
}

async function sendFromShared(){
    if(!ensureLogged()) return;

    const senderName = currentUser;
    const sender = users[senderName];
    const receiverName = sendUserInput.value.trim();
    const amount = Number(sendAmountInput.value.trim());

    if(!receiverName) return alert("Enter a username.");
    if(receiverName === senderName) return alert("Cannot send to yourself.");
    if(amount <= 0) return alert("Invalid amount.");
    if(sender.shared < amount) return alert("Insufficient shared funds.");

    // Try to load receiver from Supabase
    let receiverRow = null;
    try {
        const { data, error } = await supabaseClient
            .from("Users")
            .select("*")
            .eq("username", receiverName)
            .maybeSingle();
        if (error) console.warn("Supabase receiver lookup error:", error.message);
        receiverRow = data || null;
    } catch (err) {
        console.warn("Supabase receiver lookup failed:", err);
    }

    if (receiverRow) {
        // cloud receiver
        const receiverLocal = rowToUser(receiverRow);

        sender.shared -= amount;
        receiverLocal.balance += amount;
        receiverLocal.receivedLog.push(
            `Received ${amount} R from ${senderName}`
        );
        users[receiverName] = receiverLocal; // keep a local copy too

        saveLocalUsers();
        // update both in cloud
        await saveToSupabase(senderName);
        currentUserId = receiverRow.id;
        await saveToSupabase(receiverName);
        // restore sender id
        const senderRow = await refreshFromSupabase(senderName, sender.pin);
        if (senderRow) currentUserId = senderRow.id;

        updateHUD();
        alert(`Sent ${amount} R to ${receiverName} (cloud).`);
        return;
    }

    // Fallback: local-only receiver
    if (!users[receiverName]) {
        alert("Receiver not found (cloud or local).");
        return;
    }

    sender.shared -= amount;
    users[receiverName].balance += amount;
    users[receiverName].receivedLog.push(
        `Received ${amount} R from ${senderName}`
    );

    saveLocalUsers();
    saveToSupabase(senderName);
    updateHUD();
    alert(`Sent ${amount} R to ${receiverName} (local backup).`);
}

/* ============================================================
   EXPORT / IMPORT LOCAL BACKUP
   ============================================================ */

function exportSave(){
    const raw = localStorage.getItem("rtycoon_users");
    if(!raw) return alert("No local backup found.");

    let formatted = raw;
    try{ formatted = JSON.stringify(JSON.parse(raw),null,2); }catch(e){}

    if(navigator.clipboard){
        navigator.clipboard.writeText(formatted).then(()=>{
            alert("Local backup copied to clipboard.");
        },()=>{
            alert("Local backup:\n\n"+formatted);
        });
    } else {
        alert("Local backup:\n\n"+formatted);
    }
}

function importSave(){
    const text = importText.value.trim();
    if(!text) return alert("Paste your JSON first.");

    let obj;
    try{ obj = JSON.parse(text); }catch(e){ return alert("Invalid JSON"); }

    const newUsers = {};
    for(const n in obj){
        newUsers[n] = normalizeUser(obj[n]);
    }

    users = newUsers;
    saveLocalUsers();
    currentUser = null;
    currentUserId = null;

    closeImportModal();
    alert("Local backup imported. Log in again.");
    openLogin();
}

/* ============================================================
   HUD
   ============================================================ */

function updateHUD(){
    if(!currentUser) return;

    const U = users[currentUser];
    const now = Date.now();

    balanceText.textContent = `Balance (${currentUser}): ${U.balance} R`;
    vaultText.textContent   = `Vault: ${U.vault} R`;
    tokenText.textContent   = `Tokens: ${U.tokens} T`;
    sharedText.textContent  = `Shared Wallet: ${U.shared} R`;
    comboText.textContent   = `Last session taps: ${U.lastSessionTaps}`;

    if(now < U.cooldownEnd){
        const remain = U.cooldownEnd-now;
        const m=Math.floor(remain/60000);
        const s=Math.floor((remain%60000)/1000);
        tapMessage.textContent=`Cooldown: ${m}m ${s}s`;
    } else {
        tapMessage.textContent="Tap the coin to begin!";
    }

    userText.textContent = `User: ${currentUser} (tap to switch user)`;
}

/* ============================================================
   ON LOAD
   ============================================================ */

window.onload = ()=>{
    if(!Object.keys(users).length){
        // default guest with pin 0000, still normalized
        users["Guest"] = normalizeUser({pin:"0000"});
        saveLocalUsers();
    }

    // show login every time
    openLogin();

    // Daily check every 30 sec
    setInterval(maybeTriggerDaily, 30_000);
};
</script>

</body>
</html>