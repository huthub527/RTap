<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>R Tycoon Tapper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        text-align: center;
        background: linear-gradient(to bottom, #3a4bd1, #672ea8);
        color: white;
        overflow-x: hidden;
    }

    h1, h2, h3 { margin: 10px 0; }

    #hud {
        padding-top: 35px;
        padding-bottom: 10px;
        position: relative;
        z-index: 10;
    }

    .hudLine { margin: 4px 0; font-size: 18px; }

    #coin {
        width: 220px;
        height: 220px;
        margin: 25px auto;
        border-radius: 50%;
        background: radial-gradient(circle, #ffd861, #d49a00);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 90px;
        font-weight: bold;
        color: #5a3d00;
        box-shadow: 0 0 40px rgba(255,255,0,0.55);
        user-select: none;
        touch-action: manipulation;
        position: relative;
        z-index: 5;
    }

    .panel {
        margin: 15px auto;
        width: 90%;
        max-width: 600px;
        padding: 20px;
        background: rgba(0,0,0,0.25);
        border-radius: 18px;
    }

    button {
        width: 85%;
        max-width: 350px;
        padding: 14px;
        margin: 10px auto;
        background: rgba(255,255,255,0.1);
        border: 2px solid white;
        border-radius: 14px;
        font-size: 18px;
        color: white;
        display: block;
    }

    input {
        width: 85%;
        max-width: 350px;
        padding: 10px;
        margin: 6px auto;
        border-radius: 10px;
        border: none;
        font-size: 16px;
        text-align: center;
        display: block;
    }

    textarea {
        width: 85%;
        max-width: 380px;
        height: 140px;
        padding: 10px;
        margin: 10px auto;
        border-radius: 10px;
        border: none;
        font-size: 14px;
        resize: vertical;
        box-sizing: border-box;
    }

    #modalOverlay, #importOverlay, #dailyOverlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.75);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        backdrop-filter: blur(4px);
        overflow: hidden;
    }

    #modalBox, #importBox, #dailyBox {
        width: 88%;
        max-width: 380px;
        background: #1a1a1a;
        padding: 25px;
        border-radius: 16px;
        position: fixed;
        left: 50%; top: 50%;
        transform: translate(-50%, -50%);
        z-index: 100000;
    }
</style>
</head>

<body>

<div id="hud">
    <div id="balanceText" class="hudLine">Balance: 0 R</div>
    <div id="tapMessage" class="hudLine">Tap the coin to begin!</div>
    <div id="comboText" class="hudLine">Last session taps: 0</div>
    <div id="userText" class="hudLine">(tap to switch user)</div>
</div>

<div id="coin">R</div>

<div class="panel">
    <h2>Vault</h2>
    <h3 id="vaultText">Vault: 0 R</h3>
    <button onclick="deposit10()">Deposit 10 R</button>
    <button onclick="depositAll()">Deposit ALL R</button>
    <button onclick="withdraw10()">Withdraw 10 R → Tokens</button>
    <button onclick="withdrawAll()">Withdraw ALL R → Tokens</button>
</div>

<div class="panel">
    <h2>Token Wallet</h2>
    <h3 id="tokenText">Tokens: 0 T</h3>
</div>

<div class="panel">
    <h2>Shared Wallet</h2>
    <h3 id="sharedText">Shared Wallet: 0 R</h3>

    <button onclick="depositShared10()">Deposit 10 R from Vault → Shared</button>
    <button onclick="withdrawShared10()">Withdraw 10 R from Shared → Vault</button>

    <input id="sendUserInput" placeholder="Send to user">
    <input id="sendAmountInput" placeholder="Amount" type="number" min="1">
    <button onclick="sendFromShared()">Send from Shared → User</button>
</div>

<div class="panel">
    <h2>Data Management</h2>
    <button onclick="exportSave()">Export Save</button>
    <button onclick="openImportModal()">Import Save</button>
</div>

<!-- Login Modal -->
<div id="modalOverlay">
    <div id="modalBox">
        <h2>User Login</h2>
        <input id="usernameInput" placeholder="Username">
        <input id="pinInput" placeholder="PIN" type="password">

        <button onclick="loginUser()">Login</button>
        <button onclick="createUser()">Create User</button>
        <button style="background:#a00000" onclick="closeModal()">Cancel</button>
    </div>
</div>

<!-- Import Modal -->
<div id="importOverlay">
    <div id="importBox">
        <h2>Import Save</h2>
        <textarea id="importText" placeholder='{"User":{...}}'></textarea>
        <button onclick="importSave()">Import</button>
        <button style="background:#a00000" onclick="closeImportModal()">Cancel</button>
    </div>
</div>

<!-- Daily Math Challenge -->
<div id="dailyOverlay">
    <div id="dailyBox">
        <h2>Daily Math Challenge</h2>
        <p id="dailyQuestion">Loading…</p>
        <input id="dailyAnswer" type="number" placeholder="Your answer">
        <button onclick="submitDaily()">Submit</button>
        <button style="background:#a00000" onclick="closeDailyModal()">Close</button>
    </div>
</div>

<script>
/* ------------------------------
   NORMALIZE USERS (TapPower removed)
--------------------------------*/
let users = JSON.parse(localStorage.getItem("rtycoon_users") || "{}");

function normalizeUser(u) {
    if (!u) u = {};
    return {
        pin: u.pin || "",
        balance: Number(u.balance) || 0,
        vault: Number(u.vault) || 0,
        tokens: Number(u.tokens) || 0,

        // tapPower removed — always 1 R per tap
        tapMultiplier: 1,

        offlineBoost: Number(u.offlineBoost) || 0,
        shared: Number(u.shared) || 0,
        cooldownEnd: Number(u.cooldownEnd) || 0,
        lastSessionTaps: Number(u.lastSessionTaps) || 0,
        receivedLog: Array.isArray(u.receivedLog) ? u.receivedLog : [],

        // Daily challenge
        dailyCompleted: !!u.dailyCompleted,
        nextDailyTime: Number(u.nextDailyTime) || 0
    };
}

for (const n in users) users[n] = normalizeUser(users[n]);

let currentUser = null;
function saveUsers() {
    localStorage.setItem("rtycoon_users", JSON.stringify(users));
}
/* -------------------------
      TIMERS
--------------------------*/

const TAP_WINDOW_MS = 10_000;        // 10 seconds tapping
const COOLDOWN_MS  = 35 * 60 * 1000; // 35 minutes

let tapSessionStart = 0;
let tapCountThisSession = 0;

/* -------------------------
       MODALS
--------------------------*/

function openLogin(){ modalOverlay.style.display="flex"; }
function closeModal(){ modalOverlay.style.display="none"; }

function openImportModal(){ importOverlay.style.display="flex"; }
function closeImportModal(){ importOverlay.style.display="none"; }

function openDailyModal(){ dailyOverlay.style.display="flex"; }
function closeDailyModal(){ dailyOverlay.style.display="none"; }

/* -------------------------
     CREATE / LOGIN
--------------------------*/

function createUser(){
    const u = usernameInput.value.trim();
    const p = pinInput.value.trim();
    if(!u||!p) return alert("Enter username + PIN");
    if(users[u]) return alert("User already exists!");

    users[u] = normalizeUser({pin:p});
    saveUsers();
    alert("User created!");
}

function loginUser(){
    const u = usernameInput.value.trim();
    const p = pinInput.value.trim();
    if(!users[u]) return alert("User not found!");
    if(users[u].pin!==p) return alert("Wrong PIN!");

    currentUser = u;
    tapSessionStart = 0;
    tapCountThisSession = 0;
    closeModal();
    updateHUD();
}

/* -------------------------
        GAME LOGIC
--------------------------*/

document.getElementById("coin").addEventListener("click",()=>{

    if(!currentUser) return openLogin();
    const U = users[currentUser];
    const now = Date.now();

    // COOL DOWN
    if(now < U.cooldownEnd){
        const remain = U.cooldownEnd-now;
        const m = Math.floor(remain/60000);
        const s = Math.floor((remain%60000)/1000);
        tapMessage.textContent=`Cooldown: ${m}m ${s}s`;
        return;
    }

    // START OR RESTART TAP SESSION
    if(!tapSessionStart || now - tapSessionStart > TAP_WINDOW_MS){
        tapSessionStart = now;
        tapCountThisSession = 0;
    }

    tapCountThisSession++;

    // tapPower removed — always 1 R per tap
    U.balance += 1;

    // TAP WINDOW ENDED?
    if(now - tapSessionStart >= TAP_WINDOW_MS){
        U.cooldownEnd = now + COOLDOWN_MS;
        U.lastSessionTaps = tapCountThisSession;
        tapSessionStart = 0;
        tapCountThisSession = 0;
    }

    saveUsers();
    updateHUD();
});

/* -------------------------
       DAILY MATH
--------------------------*/

let dailyCorrectAnswer = null;

function maybeTriggerDaily(){
    if(!currentUser) return;

    const U = users[currentUser];
    const now = Date.now();

    // Already completed today?
    if(now < U.nextDailyTime) return;

    // Random chance ~ once per day:
    // 1 check every 30 seconds from 8am–10pm.
    const hour = new Date().getHours();
    if(hour < 8 || hour > 22) return;

    if(Math.random() < 0.0025){ // Roughly once per day
        startDailyChallenge();
    }
}

function startDailyChallenge(){
    const U = users[currentUser];

    // Generate equation
    let a = Math.floor(Math.random()*30)+1;
    let b = Math.floor(Math.random()*30)+1;
    dailyCorrectAnswer = a + b;

    dailyQuestion.textContent = `${a} + ${b} = ?`;
    dailyAnswer.value = "";
    openDailyModal();

    // Mark next available tomorrow
    const tomorrow = new Date();
    tomorrow.setHours(24,0,0,0);
    U.nextDailyTime = tomorrow.getTime();
    saveUsers();
}

function submitDaily(){
    const ans = Number(dailyAnswer.value.trim());
    if(ans === dailyCorrectAnswer){
        const U = users[currentUser];
        U.balance += 300;
        saveUsers();
        alert("Correct! +300 R");
        closeDailyModal();
        updateHUD();
    } else {
        alert("Incorrect.");
    }
}

/* -------------------------
     VAULT + TOKENS
--------------------------*/

function deposit10(){
    if(!currentUser) return openLogin();
    const U = users[currentUser];
    if(U.balance>=10){ U.balance-=10; U.vault+=10; saveUsers(); updateHUD(); }
}

function depositAll(){
    if(!currentUser) return openLogin();
    const U = users[currentUser];
    U.vault+=U.balance;
    U.balance=0;
    saveUsers(); updateHUD();
}

function withdraw10(){
    if(!currentUser) return openLogin();
    const U = users[currentUser];
    if(U.vault>=10){ U.vault-=10; U.tokens+=10; saveUsers(); updateHUD(); }
}

function withdrawAll(){
    if(!currentUser) return openLogin();
    const U = users[currentUser];
    U.tokens+=U.vault;
    U.vault=0;
    saveUsers(); updateHUD();
}

/* -------------------------
      SHARED WALLET
--------------------------*/

function depositShared10(){
    if(!currentUser) return openLogin();
    const U = users[currentUser];
    if(U.vault>=10){ U.vault-=10; U.shared+=10; saveUsers(); updateHUD(); }
}

function withdrawShared10(){
    if(!currentUser) return openLogin();
    const U = users[currentUser];
    if(U.shared>=10){ U.shared-=10; U.vault+=10; saveUsers(); updateHUD(); }
}

function sendFromShared(){
    if(!currentUser) return openLogin();

    const sender = users[currentUser];
    const receiverName = sendUserInput.value.trim();
    const amount = Number(sendAmountInput.value.trim());

    if(!receiverName || !users[receiverName]) return alert("User not found");
    if(receiverName===currentUser) return alert("Cannot send to yourself");
    if(amount<=0) return alert("Invalid amount");
    if(sender.shared < amount) return alert("Insufficient shared funds");

    sender.shared -= amount;
    users[receiverName].balance += amount;
    users[receiverName].receivedLog.push(
        `Received ${amount} R from ${currentUser}`
    );

    saveUsers();
    updateHUD();
}

/* -------------------------
   EXPORT / IMPORT SAVE
--------------------------*/

function exportSave(){
    const raw = localStorage.getItem("rtycoon_users");
    if(!raw) return alert("No save found.");

    let formatted = raw;
    try{ formatted = JSON.stringify(JSON.parse(raw),null,2); }catch(e){}

    if(navigator.clipboard){
        navigator.clipboard.writeText(formatted).then(()=>{
            alert("Copied to clipboard:\n\n"+formatted);
        },()=>{
            alert("Save:\n\n"+formatted);
        });
    } else {
        alert("Save:\n\n"+formatted);
    }
}

function importSave(){
    const text = importText.value.trim();
    if(!text) return alert("Paste your save JSON first.");

    let obj;
    try{ obj = JSON.parse(text); }catch(e){ return alert("Invalid JSON"); }

    const newUsers = {};
    for(const n in obj){
        newUsers[n] = normalizeUser(obj[n]);
    }

    users = newUsers;
    saveUsers();
    currentUser = null;

    closeImportModal();
    alert("Save imported! Log in again.");
    openLogin();
}

/* -------------------------
       HUD UPDATE
--------------------------*/

function updateHUD(){
    if(!currentUser) return;

    const U = users[currentUser];
    const now = Date.now();

    balanceText.textContent = `Balance (${currentUser}): ${U.balance} R`;
    vaultText.textContent   = `Vault: ${U.vault} R`;
    tokenText.textContent   = `Tokens: ${U.tokens} T`;
    sharedText.textContent  = `Shared Wallet: ${U.shared} R`;
    comboText.textContent   = `Last session taps: ${U.lastSessionTaps}`;

    if(now < U.cooldownEnd){
        const remain = U.cooldownEnd-now;
        const m=Math.floor(remain/60000);
        const s=Math.floor((remain%60000)/1000);
        tapMessage.textContent=`Cooldown: ${m}m ${s}s`;
    } else {
        tapMessage.textContent="Tap the coin to begin!";
    }

    userText.textContent = `User: ${currentUser} (tap to switch user)`;
}

/* -------------------------
      ON LOAD
--------------------------*/

window.onload = ()=>{
    if(!Object.keys(users).length){
        users["Guest"] = normalizeUser({pin:"0000"});
        saveUsers();
    }

    openLogin();

    // Daily check every 30 sec
    setInterval(maybeTriggerDaily, 30_000);
};
</script>

</body>
</html>